Bootstrap: docker
From: nvidia/cuda:11.2.2-cudnn8-runtime-ubuntu20.04

%post
    echo "Installing required packages..."
    export TZ=UTC
    export DEBIAN_FRONTEND=noninteractive
    apt-get update && apt-get install -y \
        python3 \
        python3-pip \
        build-essential \
        wget \
        git \
        bash \
        gcc \
        gfortran \
        g++ \
        make \
        file \
        && rm -rf /var/lib/apt/lists/*

    echo "Installing Open MPI 5.0.5"
    export OMPI_DIR=/opt/ompi
    export OMPI_VERSION=5.0.5
    export OMPI_URL="https://download.open-mpi.org/release/open-mpi/v5.0/openmpi-$OMPI_VERSION.tar.bz2"
    mkdir -p /tmp/ompi
    mkdir -p $OMPI_DIR
    cd /tmp/ompi && wget -O openmpi-$OMPI_VERSION.tar.bz2 $OMPI_URL && tar -xjf openmpi-$OMPI_VERSION.tar.bz2
    cd /tmp/ompi/openmpi-$OMPI_VERSION && ./configure --prefix=$OMPI_DIR && make -j$(nproc) install
    rm -rf /tmp/ompi

    # Install Python packages
    pip3 install --upgrade pip
    pip3 install -r /root/requirements.txt

%environment
    # Set environment variables
    TZ=UTC
    DEBIAN_FRONTEND=noninteractive
    export OMPI_DIR=/opt/ompi
    export PATH="$OMPI_DIR/bin:/usr/local/cuda/bin:$PATH"
    export LD_LIBRARY_PATH="$OMPI_DIR/lib:/usr/local/cuda/lib64:$LD_LIBRARY_PATH"
    export MANPATH="$OMPI_DIR/share/man:$MANPATH"

%runscript
    # Load environment variables from .env file
    if [ -f /root/.env ]; then
        export $(cat .env | xargs)
    fi

%labels
    Author Wojciech Noskowiak
    Version 1.0
    Description Singularity container for running Monte Carlo simulation with CUDA and MPI

%files
    src /root/src
    .env /root/.env
    requirements.txt /root/requirements.txt